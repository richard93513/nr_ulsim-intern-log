# 5G NR LDPC Decoder â€” From OAI to MATLAB

## ç ”ç©¶èƒŒæ™¯

ç‚ºæ·±å…¥ç†è§£ **3GPP 5G NR** è¦ç¯„ä¸­çš„ LDPC è§£ç¢¼æµç¨‹ï¼Œæˆ‘å¾ OpenAirInterface (OAI) é–‹æºå°ˆæ¡ˆä¸­çš„ `nrLDPC_decoder.c` é€²è¡Œåˆ†æï¼Œä¸¦å˜—è©¦ç”¨ MATLAB é‡å»ºè§£ç¢¼æµç¨‹ï¼Œä»¥é©—è­‰èˆ‡å­¸ç¿’æ¼”ç®—æ³•ç´°ç¯€ã€‚

---

## ä¸€ã€OAI åŸå§‹ç¢¼åˆ†æé‡é»

- ä¸»è¦æª”æ¡ˆï¼š
  - `nrLDPC_decoder.c`ï¼šLDPC è§£ç¢¼ä¸»ç¨‹å¼
  - `ldpctest.c`ï¼šæ¸¬è©¦ç¨‹å¼ï¼Œå«éš¨æ©Ÿè³‡æ–™ç”¢ç”Ÿã€ç·¨ç¢¼ã€èª¿è®Šã€AWGN é€šé“ã€è§£ç¢¼åŠéŒ¯èª¤ç‡è¨ˆç®—

- è§£ç¢¼æ ¸å¿ƒæµç¨‹ï¼š
  1. åˆå§‹åŒ–ï¼ˆé¸æ“‡ BaseGraph BG1/BG2ã€lifting size Zã€ç¢¼ç‡ç­‰ï¼‰
  2. Min-Sum è¿­ä»£è§£ç¢¼
     - CNï¼ˆCheck Nodeï¼‰è¨Šæ¯æ›´æ–°
     - BNï¼ˆBit Nodeï¼‰è¨Šæ¯æ›´æ–°
     - Parity check é©—è­‰
     - ç¡¬åˆ¤æ±ºï¼ˆhard decisionï¼‰
     - åœæ­¢æ¢ä»¶åˆ¤æ–·ï¼ˆCRC æˆ–æœ€å¤§è¿­ä»£æ•¸ï¼‰
  3. SIMD åŠ é€Ÿï¼ˆAVX512 / AVX2 / baselineï¼‰

---

## äºŒã€å¾ OAI æµç¨‹æ¨å° MATLAB å¯¦ä½œ

### 1. éš¨æ©Ÿè¼¸å…¥ç”¢ç”Ÿ

```matlab
N = 8448;  % ç¯„ä¾‹ Transport Block Size
input_bits = randi([0 1], N, 1);
```
### 2. é¸æ“‡ BaseGraph (BG1 / BG2)
- æ ¹æ“š 3GPP TS 38.212 è¦å®šï¼Œä»¥è³‡è¨Šé•·åº¦èˆ‡ç¢¼ç‡åˆ¤å®šï¼š

  - BG1 é©ç”¨æ–¼è³‡è¨Šé•·åº¦å¤§æ–¼æˆ–ç­‰æ–¼ 3840 bits

  - BG2 é©ç”¨æ–¼è¼ƒçŸ­è³‡è¨Šé•·åº¦

### 3. å»ºæ§‹ H_base çŸ©é™£
- H_base ç‚º LDPC çŸ©é™£çš„åŸºç¤çµæ§‹ï¼Œå°ºå¯¸ä¾‹ï¼š

  - BG1ï¼š46 x 68 base matrix

  - æ¯å€‹å…ƒç´ ç‚º lifting size Z çš„å³å¾ªç’°ç§»ä½é‡ï¼Œ-1 è¡¨ç¤ºé›¶çŸ©é™£ï¼ˆç©ºç™½ï¼‰

- ä¾ç…§ 3GPP æ¨™æº–è¡¨æ ¼ï¼Œå°‡å„ row èˆ‡ column index å°æ‡‰çš„åç§»å€¼å¡«å…¥ï¼Œå½¢æˆæ•´é«”è§£ç¢¼éª¨æ¶ã€‚
- æˆ‘æˆåŠŸå®Œæˆäº† BG1 ç¬¬ 0 è¡Œçš„ MATLAB ç¨‹å¼ç¢¼å»ºæ§‹ï¼Œç¯„ä¾‹å¦‚ä¸‹ï¼š
```matlab
clear; clc;
% æ‰€æœ‰ column indexï¼ˆrow=0 è³‡æ–™ä¸­æœ‰è³‡æ–™çš„é‚£äº›ï¼‰
col_index_list = [0, 1, 2, 3, 5, 6, 9, 10, 11, 12, 13, 15, 16, 18, 19, 20, 21, 22, 23];

% æ¯å€‹ column index å°æ‡‰çš„ set indexï¼ˆshift æ•¸å€¼ï¼Œ8 å€‹ä¸€çµ„ï¼‰
col_shift_values = [
    250, 307,  73, 223, 211, 294,   0, 135;   % col 0
     69,  19,  15,  16, 198, 118,   0, 227;   % col 1
    226,  50, 103,  94, 188, 167,   0, 126;   % col 2
    159, 369,  49,  91, 186, 330,   0, 134;   % col 3
    100, 181, 240,  74, 219, 207,   0,  84;   % col 5
     10, 216,  39,  10,   4, 165,   0,  83;   % col 6
     59, 317,  15,   0,  29, 243,   0,  53;   % col 9
    229, 288, 162, 205, 144, 250,   0, 225;   % col 10
    110, 109, 215, 216, 116,   1,   0, 205;   % col 11
    191,  17, 164,  21, 216, 339,   0, 128;   % col 12
      9, 357, 133, 215, 115, 201,   0,  75;   % col 13
    195, 215, 298,  14, 233,  53,   0, 135;   % col 15
     23, 106, 110,  70, 144, 347,   0, 217;   % col 16
    190, 242, 113, 141,  95, 304,   0, 220;   % col 18
     35, 180,  16, 198, 216, 167,   0,  90;   % col 19
    239, 330, 189, 104,  73,  47,   0, 105;   % col 20
     31, 346,  32,  81, 261, 188,   0, 137;   % col 21
      1,   1,   1,   1,   1,   1,   0,   1;   % col 22
      0,   0,   0,   0,   0,   0,   0,   0    % col 23
];

% åˆå§‹åŒ– H_base_row ç‚º -1
H_base_row = -1 * ones(1, 544);  % 68*8

% å°‡æœ‰å®šç¾©çš„ shift å¡«å…¥å°æ‡‰ä½ç½®
for k = 1:length(col_index_list)
    col = col_index_list(k);
    shifts = col_shift_values(k, :);  % å°æ‡‰çš„ shift æ•¸å€¼
    for i = 0:7
        idx = col * 8 + i + 1;  % MATLAB index èµ·å§‹ç‚º 1
        H_base_row(idx) = shifts(i+1);
    end
end
```
- col_index_listï¼šåªåˆ—å‡ºé€™è¡Œä¸­æœ‰å®šç¾©çš„ column indexï¼ˆéç©ºç™½ï¼‰

- col_shift_valuesï¼šæ¯å€‹ column ä¸‹ï¼Œ8 å€‹ set index çš„ shift å€¼ï¼ˆå°æ‡‰ 5G NR LDPC base graph è£¡çš„ cyclic shiftï¼‰

- H_base_rowï¼šä»£è¡¨è©²è¡Œå°æ‡‰å®Œæ•´ 68 å€‹ columnï¼Œæ¯å€‹ column æœ‰ 8 å€‹ set indexï¼Œæ‰€ä»¥é•·åº¦æ˜¯ 68*8=544
æ²’å®šç¾©çš„ä½ç½®ç”¨ -1 è¡¨ç¤ºç©ºç™½ï¼ˆç„¡é‚Šé€£æ¥ï¼‰

- for è¿´åœˆï¼šä¾ç…§ column å’Œ set index è¨ˆç®—ä½ç½®ï¼Œæ”¾å…¥å°æ‡‰çš„ shift å€¼
### 4. Min-Sum è§£ç¢¼æ¶æ§‹
```matlab
% åˆå§‹åŒ–è¨Šæ¯
LLR = received_llr;  % å¾é€šé“è¼¸å…¥çš„ log-likelihood ratio

for iter = 1:max_iterations
    % CN æ›´æ–°
    % BN æ›´æ–°
    % ç¡¬åˆ¤æ±ºä¸¦ parity check
    if parity_check_passed
        break;
    end
end
```
## ä¸‰ã€H_base å»ºæ§‹ç´°ç¯€
- åŸå§‹è³‡æ–™ä»¥ row èˆ‡ column ç‚ºç´¢å¼•ï¼Œå°æ‡‰å¤šå€‹ set index (0~7)

- é€é MATLAB å°‡æ¯å€‹ row èˆ‡ column ä¸‹çš„ set index åŠåç§»é‡æ˜ å°„è‡³å®Œæ•´çš„ parity check matrix

- åˆ©ç”¨ lifting size Z å°‡ base matrix æ“´å±•æˆå®Œæ•´å¤§å°

## å››ã€æ•´é«”è§£ç¢¼æµç¨‹åœ–

![Untitled diagram _ Mermaid Chart-2025-07-01-181634](https://github.com/user-attachments/assets/a6e66335-e354-471e-b0df-d113e55a3106)

## äº”ã€å¿ƒå¾—èˆ‡æœªä¾†è¦åŠƒ
- H_base æ˜¯ç†è§£èˆ‡å¯¦ä½œ LDPC è§£ç¢¼æœ€é—œéµçš„éƒ¨åˆ†

- ç”± 3GPP æ¨™æº–ç´°ç¯€æ•´ç† base graphï¼Œæ­é… MATLAB å¯é‚„åŸæ•´é«”è§£ç¢¼æµç¨‹

- å¾ŒçºŒè¨ˆç•«ï¼š

  - å®Œæ•´å±•é–‹ lifting çŸ©é™£ä¸¦é©—è­‰è§£ç¢¼æ­£ç¢ºæ€§

  - åŠ å…¥ CRC æ—©åœæ©Ÿåˆ¶

  - å¯¦ä½œ BER æ¸¬è©¦ä¸¦èˆ‡ OAI çµæœæ¯”å°

  - æ¢ç´¢ SIMD åŠ é€Ÿåœ¨ MATLAB çš„æ¨¡æ“¬å¯èƒ½æ€§

# 5G NR LDPC Base Graph 1 æ“´å±•ç­†è¨˜
## 1. Base Graph BG1 çµæ§‹
- 5G NR ä¸­çš„ LDPC ä½¿ç”¨å…©ç¨® Base Graphï¼ˆBG1 èˆ‡ BG2ï¼‰ã€‚

- æœ¬æ¬¡ç ”ç©¶çš„æ˜¯ BG1ï¼Œå…¶çŸ©é™£å¤§å°ç‚ºï¼š
  46 Ã— 68
  è¡¨ç¤ºæœ‰ 46 å€‹ check node å€å¡Šã€68 å€‹ variable node å€å¡Šã€‚

## 2. Set Index èˆ‡ä½ç§»é‡çš„ç†è§£
- åœ¨ 3GPP è¦æ ¼ï¼ˆå¦‚ TS 38.212ï¼‰ä¸­ï¼ŒBG1 çš„æ¯å€‹å…ƒç´ æœ€å¤šåŒ…å« 8 æ¢é‚Šï¼ˆSet Index 0~7ï¼‰ã€‚

- æ¯å€‹ set index å°æ‡‰ä¸€å€‹ä½ç§»é‡ï¼Œç‚ºä¸€å€‹æ•´æ•¸ï¼š

  - -1 è¡¨ç¤ºè©²é‚Šä¸å­˜åœ¨

  - 0 ~ Zâˆ’1 è¡¨ç¤ºå³ç§»å¤šå°‘å–®ä½

- æ¯å€‹ä½ç½®å¯ä»¥æœ‰å¤šå€‹ shift å€¼ï¼Œå¯¦éš›ä»£è¡¨å¤šæ¢ check-variable é‚Šã€‚

## 3. å£“ç¸®çŸ©é™£å»ºç«‹èˆ‡å±•é–‹åŸç†
å£“ç¸®çŸ©é™£å»ºç«‹ï¼ˆç¨‹å¼ï¼‰
- OAI åŸå§‹ç¢¼å°‡ BG1 æ‹†ç‚º 8 å€‹çŸ©é™£ï¼ˆBG1_I0 ~ BG1_I7ï¼‰ï¼Œæ¯å€‹éƒ½æ˜¯ 46Ã—68

- ç¨‹å¼ä¸­å°‡é€™ 8 å€‹çŸ©é™£é€å€‹ä¾æ¬„ä½æ‹¼æ¥ï¼Œè®Šæˆä¸€å€‹ 46Ã—544 çš„å¤§çŸ©é™£ï¼š

``matlab

for row = 1:46
    for col = 1:68
        for block = 0:7
            varName = sprintf('BG1_I%d', block);         % çµ„å‡ºè®Šæ•¸å BG1_Ix
            H_col = (col - 1)*8 + block + 1;              % è¨ˆç®—å£“ç¸®çŸ©é™£çš„æ¬„ä½ä½ç½®
            H(row, H_col) = eval([varName '(' num2str(row) ',' num2str(col) ')']);
        end
    end
end
```
- çµæœçŸ©é™£ H å³ç‚ºå£“ç¸®æ ¼å¼ï¼Œå¤§å°ç‚ºï¼š
46 Ã— 544  = 46 Ã— (68Ã—8)
å±•é–‹åŸç†
- æ¯å€‹ BG1(ğ‘–,ğ‘—) ä½ç½®å¯¦éš›åŒ…å« 8 å€‹ set index å°æ‡‰çš„ shift å€¼

- å±•é–‹æ™‚ï¼Œå°æ¯å€‹ shift å€¼å»ºç«‹ä¸€å€‹å¤§å°ç‚º ZÃ—Z çš„å–®ä½çŸ©é™£ï¼Œå³å¾ªç’°ä½ç§»æŒ‡å®šæ¬¡æ•¸

- å¤šå€‹ shift çµæœç›¸åŠ ï¼ˆmod 2ï¼‰å¾Œï¼Œæ”¾å…¥å¤§çŸ©é™£çš„å°æ‡‰å€å¡Šä¸­

- æœ€çµ‚ç”Ÿæˆçš„ parity check matrix å¤§å°ç‚ºï¼š(46 Ã— Z) Ã— (68 Ã— Z)

## 4. å±•é–‹ç¨‹å¼è§£é‡‹ï¼ˆexpand_ldpc_H_multi_shiftï¼‰
å‡½å¼è¼¸å…¥ï¼š

- H_compactï¼š46Ã—544 çš„å£“ç¸® shift çŸ©é™£

- Zï¼šlifting sizeï¼ˆå¦‚ Z = 384ï¼‰

å‡½å¼è¼¸å‡ºï¼š

- H_expandedï¼šå¯¦éš›è§£ç¢¼ç”¨çš„ LDPC parity check matrixï¼Œå¤§å°ç‚º (46Ã—Z) Ã— (68Ã—Z)

ä¸»è¦æµç¨‹ï¼š

1.å°æ¯å€‹ base graph å…ƒç´ æå–å…¶ 8 å€‹ shift å€¼

2.æ¯å€‹ shift å€¼ç”¢ç”Ÿä¸€å€‹å³ç§»çš„å–®ä½çŸ©é™£

3.å¤šå€‹ shift çµæœé€²è¡Œ XOR ç–ŠåŠ 

4.æ”¾å…¥å±•é–‹å¾ŒçŸ©é™£çš„å°æ‡‰ ZÃ—Z å€å¡Šä½ç½®

5.å…¨éƒ¨ä»¥ sparse æ ¼å¼å„²å­˜ï¼Œç¯€çœè¨˜æ†¶é«”

## 5. æª¢æŸ¥èˆ‡é©—è­‰
- å±•é–‹å¾Œçš„çŸ©é™£å¤§å°ç‚ºï¼š
17664 Ã— 26112ï¼ˆå°æ‡‰ Z = 384ï¼‰

- å¯ä½¿ç”¨ä»¥ä¸‹æ–¹å¼ç¢ºèªæ­£ç¢ºæ€§ï¼š

  - size(H_expanded)

  - nnz(H_expanded) æŸ¥çœ‹éé›¶å…ƒç´ å€‹æ•¸

  - spy(H_expanded) è§€å¯Ÿæ•´é«”ç¨€ç–çµæ§‹

  - full(H_expanded(1:Z,1:Z)) æŸ¥çœ‹ç´°ç¯€å€å¡Š

## 6. çµè«–
é€éæ­¤æ–¹æ³•ï¼Œå¯ä»¥å¾ 3GPP çš„å£“ç¸® shift çŸ©é™£æº–ç¢ºå±•é–‹å‡º LDPC è§£ç¢¼æ‰€éœ€çš„ parity check çŸ©é™£ H_expandedï¼Œ
å¯ç”¨æ–¼å¾ŒçºŒ Min-Sumã€BP ç­‰è§£ç¢¼æµç¨‹ï¼Œç¬¦åˆ 5G NR å¯¦éš›å¯¦ä½œéœ€æ±‚ã€‚
